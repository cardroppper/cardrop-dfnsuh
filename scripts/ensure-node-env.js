

/**
 * CRITICAL BUILD FIX: Ensure NODE_ENV is set before any build operations
 * 
 * This script MUST be run before any Gradle build tasks that invoke Metro bundler.
 * The NODE_ENV environment variable is REQUIRED by Expo and Metro for proper configuration.
 * 
 * Without this, the build will fail with:
 * "The NODE_ENV environment variable is required but was not specified."
 */

const fs = require('fs');
const path = require('path');

// Set NODE_ENV if not already set
if (!process.env.NODE_ENV) {
  process.env.NODE_ENV = 'production';
  console.log('✅ [ensure-node-env] Set NODE_ENV=production');
} else {
  console.log(`✅ [ensure-node-env] NODE_ENV already set to: ${process.env.NODE_ENV}`);
}

// Verify .env.production exists
const envProductionPath = path.join(__dirname, '..', '.env.production');
if (!fs.existsSync(envProductionPath)) {
  console.log('⚠️  [ensure-node-env] Creating .env.production file');
  fs.writeFileSync(envProductionPath, `NODE_ENV=production\nEXPO_NO_TELEMETRY=1\n`);
  console.log('✅ [ensure-node-env] Created .env.production');
}

// Create a temporary environment file that Gradle can source
const gradleEnvPath = path.join(__dirname, '..', 'android', 'gradle-env.properties');
const gradleEnvContent = `# Auto-generated by ensure-node-env.js - DO NOT EDIT
# This file ensures NODE_ENV is set for Gradle builds
systemProp.NODE_ENV=production
systemProp.EXPO_NO_TELEMETRY=1
`;

fs.writeFileSync(gradleEnvPath, gradleEnvContent);
console.log('✅ [ensure-node-env] Created android/gradle-env.properties');

// Verify metro.config.js exists and has NODE_ENV check
const metroConfigPath = path.join(__dirname, '..', 'metro.config.js');
if (fs.existsSync(metroConfigPath)) {
  const metroConfig = fs.readFileSync(metroConfigPath, 'utf8');
  if (!metroConfig.includes('process.env.NODE_ENV')) {
    console.log('⚠️  [ensure-node-env] WARNING: metro.config.js does not check NODE_ENV');
  } else {
    console.log('✅ [ensure-node-env] metro.config.js has NODE_ENV check');
  }
}

// Verify babel.config.js exists and has NODE_ENV check
const babelConfigPath = path.join(__dirname, '..', 'babel.config.js');
if (fs.existsSync(babelConfigPath)) {
  const babelConfig = fs.readFileSync(babelConfigPath, 'utf8');
  if (!babelConfig.includes('process.env.NODE_ENV')) {
    console.log('⚠️  [ensure-node-env] WARNING: babel.config.js does not check NODE_ENV');
  } else {
    console.log('✅ [ensure-node-env] babel.config.js has NODE_ENV check');
  }
}

console.log('\n✅ [ensure-node-env] Environment validation complete');
console.log('   NODE_ENV is set and ready for build');
console.log('   Gradle will now have access to NODE_ENV via gradle-env.properties\n');

process.exit(0);
